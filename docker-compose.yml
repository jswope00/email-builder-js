# Docker Compose configuration with profiles
# Usage:
#   Development: COMPOSE_PROFILES=dev docker compose up
#   Production:  COMPOSE_PROFILES=prod docker compose up
#   With Docker Postgres: COMPOSE_PROFILES=dev,postgres docker compose up
#
# Or use --profile flag:
#   docker compose --profile dev up
#   docker compose --profile prod up

services:
  # Optional PostgreSQL service (only if you want Docker-managed postgres)
  # Use profile 'postgres' to include this service
  postgres:
    image: postgres:16-alpine
    container_name: email-builder-postgres
    restart: unless-stopped
    profiles:
      - prod
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - email-builder-network

  # Development API service
  api-dev:
    image: node:20-alpine
    container_name: email-builder-api-dev
    profiles:
      - dev
    working_dir: /app
    command: sh -c "npm install && cd packages/email-builder-api && npm run dev"
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PORT: ${PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      NODE_ENV: ${NODE_ENV}
    ports:
      - "${API_PORT}:3001"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/packages/email-builder-api/node_modules
    # Optional: Uncomment depends_on if using Docker postgres (with postgres profile)
    # If using local postgres (host.docker.internal in DATABASE_URL), leave this commented
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    networks:
      - email-builder-network

  # Production API service
  api-prod:
    build:
      context: .
      dockerfile: packages/email-builder-api/Dockerfile
    container_name: email-builder-api
    profiles:
      - prod
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PORT: ${PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      NODE_ENV: ${NODE_ENV}
    ports:
      - "${API_PORT}:3001"
    # Optional: Uncomment depends_on if using Docker postgres (with postgres profile)
    # If using local postgres (host.docker.internal in DATABASE_URL), leave this commented
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - email-builder-network

  # Development Frontend service
  frontend-dev:
    image: node:20-alpine
    container_name: email-builder-frontend-dev
    profiles:
      - dev
    working_dir: /app
    command: sh -c "npm install && npm install @rollup/rollup-linux-arm64-musl @swc/core-linux-arm64-musl --save-optional --no-save || true && cd packages/editor-sample && npm run dev -- --host"
    env_file:
      - .env
    environment:
      VITE_API_URL: ${VITE_API_URL}
    ports:
      - "${FRONTEND_PORT}:5173"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/packages/editor-sample/node_modules
    depends_on:
      - api-dev
    networks:
      - email-builder-network

  # Production Frontend service
  frontend-prod:
    build:
      context: .
      dockerfile: packages/editor-sample/Dockerfile
    container_name: email-builder-frontend
    profiles:
      - prod
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - api-prod
    networks:
      - email-builder-network

networks:
  email-builder-network:
    driver: bridge

volumes:
  postgres_data:
